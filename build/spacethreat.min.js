/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

(function(){var e,t,n;(function(r){function d(e,t){return h.call(e,t)}function v(e,t){var n,r,i,s,o,u,a,f,c,h,p=t&&t.split("/"),d=l.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(f=0;f<e.length;f+=1){h=e[f];if(h===".")e.splice(f,1),f-=1;else if(h===".."){if(f===1&&(e[2]===".."||e[0]===".."))break;f>0&&(e.splice(f-1,2),f-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(f=n.length;f>0;f-=1){r=n.slice(0,f).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=f;break}}}if(s)break;!u&&v&&v[r]&&(u=v[r],a=f)}!s&&u&&(s=u,o=a),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function m(e,t){return function(){return s.apply(r,p.call(arguments,0).concat([e,t]))}}function g(e){return function(t){return v(t,e)}}function y(e){return function(t){a[e]=t}}function b(e){if(d(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!d(a,e)&&!d(c,e))throw new Error("No "+e);return a[e]}function w(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function E(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice;o=function(e,t){var n,r=w(e),i=r[0];return e=r[1],i&&(i=v(i,t),n=b(i)),i?n&&n.normalize?e=n.normalize(e,g(t)):e=v(e,t):(e=v(e,t),r=w(e),i=r[0],e=r[1],i&&(n=b(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return m(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:E(e)}}},i=function(e,t,n,i){var s,l,h,p,v,g=[],w;i=i||e;if(typeof n=="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(v=0;v<t.length;v+=1){p=o(t[v],i),l=p.f;if(l==="require")g[v]=u.require(e);else if(l==="exports")g[v]=u.exports(e),w=!0;else if(l==="module")s=g[v]=u.module(e);else if(d(a,l)||d(f,l)||d(c,l))g[v]=b(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,m(i,!0),y(l),{}),g[v]=a[l]}}h=n.apply(a[e],g);if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!w)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){return typeof e=="string"?u[e]?u[e](t):b(o(e,t).f):(e.splice||(l=e,t.splice?(e=t,t=n,n=null):e=r),t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s)},s.config=function(e){return l=e,l.deps&&s(l.deps,l.callback),s},n=function(e,t,n){t.splice||(n=t,t=[]),!d(a,e)&&!d(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}})(),n("almond",function(){}),n("globals",[],function(){var e={flockTime:0,mainStage:null,stage:null,stageWidth:null,stageHeight:null,tank:null,invaders:[],invaderSpacing:70,numInvaderRows:4,numInvaderColumns:5,groupHug:!1,gamePause:!0,fixedStageDims:{width:800,height:600},pupilRatio:1.6};return e.numInvaders=e.numInvaderRows*e.numInvaderColumns,e.flockTarget={x:e.invaderSpacing/2,y:e.invaderSpacing/2,direction:1},e}),n("sounds",["globals"],function(e){var t=!1,n=0,r=0,i=0,s=0,o=.06,u=2,a=44100,f=0,l=.1,c=l,h=.4*l,p,d={audioCtx:0,realTime:0,generateAudioBuffer:{boomSound:function(){var e=.8,t=e*a,n=new Array(t),r,i,s,o=440;for(var u=0;u<t;u++)r=u/a,i=(t-u)/t,s=i*i,n[u]=s*Math.sin(o*i*r*Math.PI*2)*Math.random(),n[u]+=s*s*Math.sin(12/Math.sqrt(i*10)*r*Math.PI*2)*20*Math.random(),n[u]*=Math.random();return n},invaderSweep:function(){var e=3,t=e*a,n=new Array(t),r,i,s,o,u,f,l;for(var c=0;c<t;c++)r=c/a,i=(e-r)/e,s=r/e,o=i*s,u=Math.sin(Math.PI*2*r*440*i),f=Math.sin(Math.PI*2*r*220*s),f=f>0?1:-1,l=Math.sin(Math.PI*2*r*550*o),l=l>0?1:-1,n[c]=u*u-.5,n[c]-=f/2,n[c]+=l*.5,n[c]/=3;return n},smoothWindow:function(){var e=16384,t=new Float32Array(e);for(var n=0;n<e;++n)t[n]=Math.sin(Math.PI*n/e);return t}},scheduleInvaderGrain:function(){var t=1,r=d.audioCtx.createBufferSource();r.buffer=s;var i=d.audioCtx.createPanner();i.panningModel=webkitAudioPannerNode.EQUALPOWER,i.refDistance=e.fixedStageDims.width/8,i.maxDistance=e.fixedStageDims.width/2,i.rolloffFactor=.4,i.setPosition(e.flockTarget.x+e.invaderSpacing*e.numInvaderRows/2-e.fixedStageDims.width/2,e.flockTarget.y+e.invaderSpacing*e.numInvaderColumns/2-e.fixedStageDims.height/2,100),i.connect(n);var u;u=d.audioCtx.createGainNode();var a=d.audioCtx.createGainNode();a.gain.value=o,r.connect(u),u.connect(a),a.connect(i);var l=(Math.random()-.5)*2*s.duration;r.noteGrainOn(d.realTime,f+l,c);var v=c;u.gain.value=0,u.gain.setValueCurveAtTime(p,d.realTime,v);var m=f;d.realTime+=h,f+=t*h,f>s.duration&&(f=0),f<0&&(f+=s.duration)},scheduleAudio:function(){if(t){if(!e.gamePause){var n=d.audioCtx.currentTime;while(d.realTime<n+.1)d.scheduleInvaderGrain()}setTimeout(d.scheduleAudio,100)}},initAudio:function(){if(!AudioContext)return undefined;t=!0;var e=d.audioCtx=new AudioContext;if(e){var o=d.generateAudioBuffer.boomSound();i=e.createBuffer(1,o.length,a),i.getChannelData(0).set(o);var u=d.generateAudioBuffer.invaderSweep();s=e.createBuffer(1,u.length,a),s.getChannelData(0).set(u),r=e.createGainNode(),r.connect(e.destination),r.gain.value=.5,n=e.createDynamicsCompressor(),n.connect(r);var f=e.createBiquadFilter();f.type=0,f.frequency.value=80,f.Q.value=20,f.connect(n),p=d.generateAudioBuffer.smoothWindow()}},playCannonSound:function(){if(t){var r=d.audioCtx.createBufferSource();r.buffer=i;var s=d.audioCtx.createPanner();s.panningModel=webkitAudioPannerNode.EQUALPOWER,s.refDistance=200,s.maxDistance=400,s.setPosition(e.tank.pos.x-e.fixedStageDims.width/2,0,100);var o=d.audioCtx.createBiquadFilter();o.type=2,o.frequency.value=80,o.Q.value=20,r.connect(o);var u=d.audioCtx.createGainNode();u.gain.value=5,o.connect(s),s.connect(u),u.connect(n),r.noteOn(0)}}};return d}),n("speech",{textfont:"18pt Calibri",exclamations:["Whoa!","Watch out!","Carefull!","aaAARGH!","Damn fool!","WTF?","Chill it!","Seriously?","Stop that!","WHY?","Eek!","Hey now!","NOOooo!","Chips!","Incoming!","Yikes!","Daayyuum!"],exclaim:function(){return this.exclamations[Math.floor(Math.random()*this.exclamations.length)]},dialogue:["EVERYONE! STAY IN FORMATION!.","Why are we going so slowly?",'It\'s prescribed in the "Alien contact manual".',"But why? What is the sense in it?","It's to make us appear unthreatening.","I don't think it is working.","Look! Just stay in formation!","TIME TO INNITIATE GROUP HUG!","This is embarrasing...","SHOW THIS ALIEN SOME LOVE!!","Do not feel embasassed."],dialoguePos:0,converse:function(){var e=this.dialogue[this.dialoguePos++];return this.dialoguePos>=this.dialogue.length&&(this.dialoguePos=0),e},insults:["A projectile weapon, how quaint.","We're flying here!","We came from outer space man!","We have all sorts of advanced technology.","Did I mention we can fly?","You think a projectile weapon is appropriate?","Wow. You just keep trying, don't you?","And you thought that shot would be different?","I don't think you're a quick learner.","Look! We're just doing our jobs. OK?","GET HIM!"],insultPos:0,insult:function(){var e=this.insults[this.insultPos++];return this.insultPos>=this.insults.length&&(this.insultPos=0),e}}),n("drawShapes",["globals","speech"],function(e,t){var n={makeCannonFlash:function(e,t,r,i,s){var o=new Kinetic.Group;o.innerRadius=e,o.outerRadius=t,o.divs=r;for(var u=0;u<5;u++){var a=new Kinetic.Shape({drawFunc:n.flash,name:"flashShape",fill:i,stroke:s});a.setPosition((Math.random()-.5)*e,(Math.random()-.5)*e),a.setRotation(Math.random()*Math.PI/4),o.add(a)}return o},flash:function(t){var n=t.getContext(),r=this.getParent(),i=r.innerRadius,s=r.outerRadius,o=r.divs,u=e.flockTime,a=1;typeof r.timeToDie=="undefined"?r.timeToDie=u+r.flashTime:a=(r.timeToDie-u)/r.flashTime,this.setOpacity(a*a*a),n.beginPath();var f=Math.PI*2/o,l,c,h,p,d,v,m;n.moveTo(s,0);for(var g=0;g<o;g++)l=f*(g+1),v=Math.cos(l),m=Math.sin(l),l-=f/3,p=Math.cos(l),d=Math.sin(l),l-=f/3,c=Math.cos(l),h=Math.sin(l),n.bezierCurveTo(c*i,h*i,p*i,d*i,v*s,m*s);n.closePath(),t.fillStroke(this)},speechBubbleDraw:function(e){var n=e.getContext(),r=20,i=this.w,s=i/2-i*.2,o=10,u=this.h,a=10,f=this.text;n.beginPath(),n.moveTo(0,0),n.lineTo(-i/2+s+o,r),n.arcTo(i/2,r,i/2,r+u,a),n.arcTo(i/2,r+u,-i/2,r+u,a),n.arcTo(-i/2,r+u,-i/2,r,a),n.arcTo(-i/2,r,-i/2+s,r,a),n.lineTo(-i/2+s,r),n.lineTo(0,0),n.fillStyle="#EEE",n.fill(),n.lineWidth=2,n.strokeStyle="black",n.stroke(),n.font=t.textfont,n.fillStyle="black",n.fillText(f,-i/2+4,u/2+r+8)},tankDraw:function(e){var t=e.getContext(),r=this.size;t.beginPath(),t.moveTo(r/6,0),t.lineTo(r/8,-r),t.lineTo(-r/8,-r),t.lineTo(-r/6,0),t.closePath();var i=t.createLinearGradient(r/8,0,-r/8,0);i.addColorStop(0,this.fillStyle),i.addColorStop(.5,"#FFF"),i.addColorStop(1,this.fillStyle),t.fillStyle=i,t.fill(),t.lineWidth=2,t.strokeStyle=this.strokeStyle,t.stroke();var s=r*.3,o=t.createRadialGradient(s*.4,-s*.4,0,0,0,s);o.addColorStop(0,"#FFF"),o.addColorStop(1,this.fillStyle),n.circle(t,s,o,this.strokeStyle,2),t.beginPath(),t.moveTo(r,r),t.lineTo(r,r/6),t.lineTo(r/5,0),t.lineTo(-r/5,0),t.lineTo(-r,r/6),t.lineTo(-r,r),t.closePath();var u=t.createRadialGradient(r*.1,-r*.4,0,0,r*.3,r);u.addColorStop(0,"#FFF"),u.addColorStop(1,this.fillStyle),t.fillStyle=u,t.fill(),t.lineWidth=2,t.strokeStyle=this.strokeStyle,t.stroke()},circle:function(e,t,n,r,i,s){typeof i=="undefined"&&(i=1),typeof s=="undefined"&&(s={x:0,y:0}),e.beginPath(),e.arc(s.x,s.y,t,0,2*Math.PI,!1),e.fillStyle=n,e.fill(),e.lineWidth=i,e.strokeStyle=r,e.stroke()},gear:function(e){var t=e.getContext(),n=this.innerRadius,r=this.spokeHeight,i=this.epsilon,s=this.divs;t.beginPath();var o=Math.PI/s,u;for(var a=0;a<s*2;a+=2)u=o*(a+1),t.arc(0,0,n+r,o*a+i,u-i,!1),t.arc(0,0,n,o*a+o+i,u+o-i,!1);t.closePath(),e.fillStroke(this)},eyeBall:function(t){var r=t.getContext(),i=this.getParent().lookAtTarget.getPosition(),s=this.radius,o=this.getParent().getPosition(),u=this.getPosition(),a=e.pupilRatio,f=new Object,l=s-s/a,c={x:i.x-(o.x+u.x+e.flockTarget.x),y:i.y-(o.y+u.y+e.flockTarget.y)},h=Math.sqrt(Math.pow(c.x,2)+Math.pow(c.y,2));f.x=h>l?c.x*l/h:c.x,f.y=h>l?c.y*l/h:c.y,n.circle(r,s,"#FFF","#000",2),n.circle(r,s/a,"#000","#000",1,{x:f.x,y:f.y})},tentacle:function(t){var n=t.getContext(),r=7,i=e.flockTime*r%(2*Math.PI),s=this.l;n.beginPath(),n.moveTo(0,8),n.bezierCurveTo(s/3,Math.sin(i)*5,7*s/8,Math.sin(i+Math.PI/8)*10,s,Math.sin(i+Math.PI/7)*5),n.bezierCurveTo(7*s/8,Math.sin(i+Math.PI/8)*10,s/3,Math.sin(i)*5,0,-10),n.lineWidth=3,t.fillStroke(this)},drawBackDrop:function(t){var n=t.getContext(),r=e.fixedStageDims,i=e.fixedStageDims.width,s=e.fixedStageDims.height;n.beginPath(),n.rect(0,0,i,r.height);var o=n.createLinearGradient(0,s,0,0);o.addColorStop(0,"#FFF"),o.addColorStop(.3,"#BEE"),o.addColorStop(1,"#006"),n.fillStyle=o,n.fill();var u=160,a=50,f=10,l=100,c=20,h,p,d;n.lineWidth=1,n.strokeStyle="#646464";for(var v=0;v<u;v++)d=Math.random()*i,h=Math.random()*(a-f)+f,p=Math.random()*(l-c)+c,n.beginPath(),n.rect(d-h/2,s-p,h,p),n.fillStyle="rgb("+(125+Math.floor(Math.random()*15))+","+(125+Math.floor(Math.random()*15))+","+(125+Math.floor(Math.random()*45))+")",n.fill(),n.stroke();n.fillStyle="#444";var m=5;n.beginPath(),n.moveTo(0,s),n.lineTo(0,s-m*3),n.lineTo(m,s-m*3),n.lineTo(m,s-m),n.lineTo(i-m,s-m),n.lineTo(i-m,s-m*3),n.lineTo(i,s-m*3),n.lineTo(i,s),n.closePath(),n.fill(),n.stroke()}};return n}),n("game",["sounds","speech","drawShapes","globals"],function(e,t,n,r){window.AudioContext=window.AudioContext||window.webkitAudioContext,window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};var i={},s=["left","right","shoot"],o={left:37,right:39,shoot:38},u=function(e){for(var t=0;t<s.length;t++)if(o[s[t]]==e)return!0},a=15,f=function(e){var t=0,n=r.groupHug?30:100;i[o.left]&&(t+=-n),i[o.right]&&(t+=n);var s=r.tank;s.pos.x+=t*e,s.pos.x<s.size+a&&(s.pos.x=s.size+a),s.pos.x>r.fixedStageDims.width-s.size-a&&(s.pos.x=r.fixedStageDims.width-s.size-a),s.setPosition(s.pos.x,s.pos.y);var u=s.wheels;for(var f=0;f<s.numWheels;f++)u[f].setRotation(s.pos.x/s.wheelRadius/2)},l=[];for(var c=0;c<r.numInvaders;c++)l.push({x:Math.random()*100-50,y:Math.random()*-50});var h=5,p=h/3,d=0,v=function(e){r.flockTime+=e;var n=r.flockTarget,i=r.numInvaderRows,s=r.numInvaderColumns,o=r.numInvaders,u=r.invaderSpacing,a=r.fixedStageDims,f=r.tank;if(n.y+i*u<a.height-u*.7){var c=Math.pow(Math.sin(r.flockTime*3),2);n.x+=c*u*e*n.direction,n.x+s*u-u/2>a.width?n.direction!=-1&&(n.y+=u,n.direction=-1):n.x<u/2&&n.direction!=1&&(n.y+=u,n.direction=1)}else r.groupHug=!0;var v=r.stage.get("#Shapes")[0],m=v.get("#projectile")[0],g,y=r.invaders,b=y.getChildren(),w=y.getPosition();y.setPosition(w.x+(n.x-w.x)*.1,w.y+(n.y-w.y)*.06);for(var E=0;E<o;E++){g=b[E];if(r.groupHug)g.pos.x+=(f.pos.x+l[E].x-g.pos.x-w.x)*.06,g.pos.y+=(f.pos.y+l[E].y-g.pos.y-w.y)*.05;else{var S={x:E%s,y:Math.floor(E/s)};g.pos.x+=(S.x*u-g.pos.x)*.06,g.pos.y+=(S.y*u-g.pos.y)*.05}if(m){var x={x:g.pos.x-m.pos.x+w.x,y:g.pos.y-m.pos.y+w.y},T=Math.sqrt(Math.pow(x.x,2)+Math.pow(x.y,2));x.x=x.x/T,x.y=x.y/T;var N=u;if(T<N){var C=Math.pow((N-T)/N,2)*30;g.pos.x+=x.x*C*3,g.pos.y+=x.y*C,g.lookAtTarget=m,!g.speaking&&E>s&&Math.random()<.01&&g.speak(t.exclaim(),1)}else g.lookAtTarget=f}g.setPosition(g.pos.x,g.pos.y)}if(p<0)if(r.groupHug){for(var k=0;k<o;k+=3)b[k].speak("GROUP HUG!",2);p=h*100}else{f.attacking&&(g=b[Math.floor(Math.random()*(b.length-s))+s],f.attacking=!1,g.speak(t.insult(),2));var L=d+Math.floor(s/2);d++,d>1&&(d=0);while(b[L].speaking)L++;g=b[L],g.speak(t.converse(),3),p=h}else p-=e},m=200,g=function(t){var s=r.stage.get("#Shapes")[0],u=s.get("#projectile")[0],a=r.tank;if(u){u.pos.y-=m*t,u.setPosition(u.pos.x,u.pos.y);if(u.pos.y<-200)u.remove();else{var f=1.9,l=n.makeCannonFlash(5,8,5,"rgba(255,225,200,0.1)","rgba(255,225,200,0.1)");l.setPosition(u.pos.x,u.pos.y),l.flashTime=f,s.add(l),window.setTimeout(function(){l.remove()},f*1e3)}}else if(!r.groupHug&&i[o.shoot]){a.attacking=!0,u=new Kinetic.Circle({id:"projectile",radius:5,fill:"#FAC",stroke:"#700"}),u.pos={x:a.pos.x,y:a.pos.y-a.size},u.setPosition(u.pos.x,u.pos.y),s.add(u),e.playCannonSound();var c=.3,h=n.makeCannonFlash(5,30,6,"rgba(255,255,0,0.3)","rgba(255,255,255,0.1)");h.setPosition(a.pos.x,a.pos.y-a.size),h.flashTime=c,s.add(h),window.setTimeout(function(){h.remove()},c*1e3)}var p=r.stage.get(".flashShape");$.each(p,function(e,t){var n=t.getParent();t.setPosition((Math.random()-.5)*n.innerRadius,(Math.random()-.5)*n.innerRadius),t.setRotation(Math.random()*Math.PI/4)})},y=[],b=function(e,t){var n=$("<div>").css("font",t).css("display","inline").html(e);$("body").append(n);var r={width:$(n).width(),height:$(n).height()};return $(n).remove(),r},w=function(e,i){if(!this.speaking){this.speaking=!0;var s=b(e,t.textfont),o=new Kinetic.Shape;o.setDrawFunc(n.speechBubbleDraw),o.w=s.width+7,o.h=s.height+7,o.text=e,o.invaderNum=this.invaderNum,y.push(o),r.stage.get("#Speech")[0].add(o);var u=this;window.setTimeout(function(){var e=y.indexOf(o);y.splice(e,0),o.remove(),u.speaking=!1},i*1e3)}},E=function(e){var t=r.invaders.getChildren(),n=r.invaders.getPosition();for(var i=0;i<y.length;i++){var s=y[i],o=t[s.invaderNum],u=o.getPosition();s.setPosition(u.x+n.x,u.y+n.y)}},S=function(e){r.gamePause||(f(e),v(e),g(e))},x=1,T=function(){var e=r.stage;if(e!==null){r.stageWidth=r.mainStage.width()-2,r.stageHeight=r.mainStage.height()-2;var t=r.stageWidth/r.stageHeight,n=r.fixedStageDims.width/r.fixedStageDims.height,i;t>n?(x=r.stageHeight/r.fixedStageDims.height,i=r.stageWidth*n/t,e.setSize(i,r.stageHeight)):(x=r.stageWidth/r.fixedStageDims.width,i=r.stageWidth,e.setSize(i,r.stageHeight/n*t)),e.setScale(x)}};$(window).resize(T);var N=function(){t.dialoguePos=0,t.insultPos=0,r.flockTarget={x:r.invaderSpacing/2,y:r.invaderSpacing/2,direction:1},r.groupHug=!1;var e=r.tank;e.pos={x:r.fixedStageDims.width/2,y:r.fixedStageDims.height-40},e.setPosition(e.pos.x,e.pos.y),p=h/3,d=0},C=function(){e.audioCtx&&(e.realTime=e.audioCtx.currentTime),r.gamePause=!1},k=function(){r.gamePause=!0},L=function(e,t){var i=r.invaderSpacing/4,s=new Kinetic.Group;s.speak=w,s.radius=30,s.invaderNum=e,s.speaking=!1,s.lookAtTarget=t;var o=new Kinetic.Circle({radius:i,stroke:"rgba(0,0,0,0.5)",fillRadialGradientStartPoint:[i/4,-i/4],fillRadialGradientStartRadius:0,fillRadialGradientEndPoint:0,fillRadialGradientEndRadius:i,fillRadialGradientColorStops:[0,"#FFF",1,"rgba(125,255,125,0.5)"]});s.add(o);var u=3,a,f=Math.PI/2/u;for(a=0;a<u;a++){var l=o.clone();l.setDrawFunc(n.tentacle),l.setName("tentacle"),l.l=r.invaderSpacing/4-2,l.setPosition(i*Math.cos(f*a),i*Math.sin(f*a)),l.setRotation(f*a),s.add(l)}for(a=0;a<u;a++){var l=o.clone();l.setDrawFunc(n.tentacle),l.setName("tentacle"),l.l=-r.invaderSpacing/4-2,l.setPosition(-i*Math.cos(f*a),i*Math.sin(f*a)),l.setRotation(-f*a),s.add(l)}var c=new Kinetic.Shape({drawFunc:n.eyeBall,x:-10});c.radius=8+Math.round((Math.random()+.5)*2);var h=new Kinetic.Shape({drawFunc:n.eyeBall,x:10});h.radius=8+Math.round((Math.random()+.5)*2),s.add(c),s.add(h);var p={x:e%r.numInvaderColumns,y:Math.floor(e/r.numInvaderColumns)};return s.pos={x:p.x*r.invaderSpacing,y:p.y*r.invaderSpacing},s.setPosition(s.pos.x,s.pos.y),s},A=function(e){var t=new Kinetic.Group;for(var n=0;n<r.numInvaders;n++){var i=L(n,e);t.add(i)}return t},O=function(){var e=new Kinetic.Group;e.attacking=!1;var t=new Kinetic.Shape;t.setDrawFunc(n.tankDraw),e.size=t.size=30,t.fillStyle="#B55",t.strokeStyle="black",e.add(t);var r=new Kinetic.Shape({drawFunc:n.gear,fillRadialGradientStartPoint:0,fillRadialGradientStartRadius:0,fillRadialGradientEndPoint:0,fillRadialGradientEndRadius:0,fillRadialGradientColorStops:[0,"#FFA",.4,"#FFA",.45,"#000",.5,"#555",1,"#111"],strokeStyle:t.strokeStyle});r.innerRadius=t.size/4.1,r.spokeHeight=r.innerRadius/5,e.wheelRadius=r.innerRadius+r.spokeHeight,r.setFillRadialGradientEndRadius(e.wheelRadius),e.numWheels=4;var i=e.wheels=[];for(var s=0;s<e.numWheels;s++)i[s]=r.clone(),i[s].innerRadius=r.innerRadius,i[s].spokeHeight=r.spokeHeight,i[s].epsilon=.09,i[s].divs=7,i[s].setPosition(-t.size+s*(t.size*2/(e.numWheels-1)),t.size-r.innerRadius/2),e.add(i[s]);return e},M=function(t){var s=$("#"+t);s.append('<form><input id="controlInput" type="text" /></form>'),s.after('<button id="restart">RESTART</button>'),e.initAudio(),r.mainStage=s,r.stageWidth=s.width()-2,r.stageHeight=s.height()-2,r.stage=new Kinetic.Stage({container:t,width:r.stageWidth,height:r.stageHeight,listening:!1}),T();var o=new Kinetic.Layer({id:"BackDrop"}),a=new Kinetic.Shape({drawFunc:n.drawBackDrop});o.add(a),r.stage.add(o);var f=new Kinetic.Layer({id:"Shapes"}),l=new Kinetic.Layer({id:"Speech"});r.stage.add(f),r.stage.add(l),r.tank=O(),f.add(r.tank),r.invaders=A(r.tank),f.add(r.invaders),N();var c=new Date,h=c.getTime();$("#controlInput").focus(C),$("#controlInput").blur(k),$("#controlInput").focus(),s.click(function(){$("#controlInput").focus()}),$("#controlInput").keydown(function(e){if(e.which===27){$("#controlInput").blur();return}u(e.which)&&(i[e.which]=!0),e.preventDefault()}),$("#controlInput").keyup(function(e){u(e.which)&&(i[e.which]=!1),e.preventDefault()}),$("#restart").click(N);var p=new Kinetic.Animation(function(e){var t=e.timeDiff/1e3;S(t)},f),d=new Kinetic.Animation(function(e){var t=e.timeDiff/1e3;E(t)},l);p.start(),d.start(),e.scheduleAudio()};return{init:M}}),spacethreat=t("game")})();